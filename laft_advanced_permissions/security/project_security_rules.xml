<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">
        
        <!-- ========================================== -->
        <!-- PROJECT.PROJECT RULES                       -->
        <!-- ========================================== -->
        
        <!-- Rule 1: Project User - Own Projects Only -->
        <record id="project_rule_user_own_only" model="ir.rule">
            <field name="name">Laft: Projects - User sees own only</field>
            <field name="model_id" ref="project.model_project_project"/>
            <field name="domain_force">[
                '|',
                    ('user_id', '=', user.id),
                    '|',
                        ('message_partner_ids', 'in', [user.partner_id.id]),
                        ('task_ids.user_ids', 'in', user.id)
            ]</field>
            <field name="groups" eval="[(4, ref('group_project_user_own'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Rule 2: Project Manager - Own Projects Only -->
        <record id="project_rule_manager_own_only" model="ir.rule">
            <field name="name">Laft: Projects - Manager sees own only</field>
            <field name="model_id" ref="project.model_project_project"/>
            <field name="domain_force">[
                '|',
                    ('user_id', '=', user.id),
                    ('message_partner_ids', 'in', [user.partner_id.id])
            ]</field>
            <field name="groups" eval="[(4, ref('group_project_manager_own'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <!-- Rule 3: General Manager - See All Projects -->
        <record id="project_rule_general_manager_all" model="ir.rule">
            <field name="name">Laft: Projects - General Manager sees all</field>
            <field name="model_id" ref="project.model_project_project"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_project_general_manager'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <!-- ========================================== -->
        <!-- PROJECT.TASK RULES                          -->
        <!-- ========================================== -->
        
        <!-- Rule: Tasks follow project access -->
        <record id="task_rule_follow_project" model="ir.rule">
            <field name="name">Laft: Tasks - Follow project access</field>
            <field name="model_id" ref="project.model_project_task"/>
            <field name="domain_force">[
                '|',
                    ('project_id.user_id', '=', user.id),
                    '|',
                        ('user_ids', 'in', user.id),
                        ('project_id.message_partner_ids', 'in', [user.partner_id.id])
            ]</field>
            <field name="groups" eval="[(4, ref('group_project_manager_own'))]"/>
        </record>

        <!-- ========================================== -->
        <!-- ACCOUNT.MOVE (VENDOR BILLS) RULES           -->
        <!-- ========================================== -->
        
        <!-- Rule: Vendor Bills - Project Related Only (Customer Invoices are automatically excluded) -->
        <record id="vendor_bill_rule_project_manager" model="ir.rule">
            <field name="name">Laft: Vendor Bills - Project Manager sees project-related only</field>
            <field name="model_id" ref="account.model_account_move"/>
            <field name="domain_force">[
                ('move_type', '=', 'in_invoice'),
                ('project_id', '!=', False),
                ('project_id.user_id', '=', user.id)
            ]</field>
            <field name="groups" eval="[(4, ref('group_project_manager_finance'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!-- Note: Customer Invoices are blocked automatically because the rule above 
             only allows 'in_invoice' type. No need for a separate blocking rule. -->

        <!-- ========================================== -->
        <!-- PURCHASE.ORDER RULES                        -->
        <!-- ========================================== -->
        
        <!-- Rule: Purchase Orders - Project Related Only -->
        <record id="purchase_order_rule_project_manager" model="ir.rule">
            <field name="name">Laft: Purchase Orders - Project Manager sees project-related only</field>
            <field name="model_id" ref="purchase.model_purchase_order"/>
            <field name="domain_force">[
                ('project_id', '!=', False),
                ('project_id.user_id', '=', user.id)
            ]</field>
            <field name="groups" eval="[(4, ref('group_project_manager_finance'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- ========================================== -->
        <!-- IR.ATTACHMENT (FILES) RULES                 -->
        <!-- ========================================== -->
        
        <!-- Rule: Files - Project Manager full access -->
        <record id="attachment_rule_project_manager" model="ir.rule">
            <field name="name">Laft: Files - Project Manager full access</field>
            <field name="model_id" ref="base.model_ir_attachment"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_project_manager_own'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

    </data>
</odoo>

