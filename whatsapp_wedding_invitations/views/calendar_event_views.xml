<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Calendar Event Form View -->
    <record id="view_calendar_event_form_inherit_whatsapp" model="ir.ui.view">
        <field name="name">calendar.event.form.inherit.whatsapp</field>
        <field name="model">calendar.event</field>
        <field name="inherit_id" ref="calendar.view_calendar_event_form"/>
        <field name="arch" type="xml">
            <!-- Add button in sheet after name field -->
            <xpath expr="//sheet//field[@name='name']" position="after">
                <button name="action_send_whatsapp_invitations"
                        type="object"
                        string="Send WhatsApp Invitations"
                        class="btn-primary float-end"
                        icon="fa-whatsapp"
                        invisible="guest_count == 0"/>
            </xpath>
            <xpath expr="//field[@name='description']" position="after">
                <field name="invitation_image"/>
            </xpath>

            <xpath expr="//sheet" position="before">
                <header>
                    <button name="open_related_event"
                            type="object"
                            string="Open Event"
                            class="btn-primary"/>
                </header>
            </xpath>

            <!-- Add guests section in notebook -->
            <!-- Note: If notebook doesn't exist in calendar.event form, this will need to be adjusted -->
            <xpath expr="//notebook" position="inside">
                <page string="Guests" name="guests">
                    <group>
                        <field name="guest_count" widget="statinfo" string="Total Guests"/>
                        <field name="invitation_sent_count" widget="statinfo" string="Invitations Sent"/>
                        <field name="invitation_failed_count" widget="statinfo" string="Invitations Failed"/>
                    </group>
                    <group>
                        <field name="invitation_message_template"
                               placeholder="Message template for invitations. Use {name}, {event_name},{date},{venue}, {time} as placeholders."
                               widget="text"/>
                    </group>
                    <field name="event_guest_ids" nolabel="1">
                        <list string="Guests" editable="bottom">
                            <field name="name" required="1"/>
                            <field name="phone_number" required="1"/>
                            <field name="email"/>
                            <field name="invitation_status" widget="badge"
                                   decoration-success="invitation_status == 'sent'"
                                   decoration-danger="invitation_status == 'failed'"
                                   decoration-muted="invitation_status == 'not_sent'"/>
                            <field name="invitation_sent_date"/>
                            <field name="rsvp_status" widget="badge"
                                   decoration-success="rsvp_status == 'accepted'"
                                   decoration-danger="rsvp_status == 'declined'"
                                   decoration-muted="rsvp_status == 'pending'"/>
                            <field name="notes"/>
                        </list>
                        <form string="Guest">
                            <sheet>
                                <group>
                                    <group>
                                        <field name="name" required="1"/>
                                        <field name="phone_number" required="1"/>
                                        <field name="email"/>
                                    </group>
                                    <group>
                                        <field name="event_id" readonly="1"/>
                                        <field name="invitation_status"/>
                                        <field name="invitation_sent_date" readonly="1"/>
                                        <field name="rsvp_status"/>
                                    </group>
                                </group>
                                <group>
                                    <field name="invitation_error" readonly="1"
                                           invisible="invitation_status != 'failed'"/>
                                    <field name="message_id" readonly="1"/>
                                    <field name="notes"/>
                                </group>
                            </sheet>
                        </form>
                    </field>
                </page>
            </xpath>
        </field>
    </record>
</odoo>

